<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Nearby Mental Health Services</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- REMOVED: sql.js is no longer needed -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script> -->

    <style>
        /* Custom styles */
        html, body {
            height: 100%;
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Tailwind gray-100 */
        }
        /* Custom scrollbar */
        #results-container::-webkit-scrollbar {
            width: 8px;
        }
        #results-container::-webkit-scrollbar-thumb {
            @apply bg-blue-300 rounded-full;
        }
        #results-container::-webkit-scrollbar-track {
            @apply bg-gray-100;
        }
    </style>
    <!-- Add Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="flex flex-col md:flex-row h-screen bg-gray-100">

    <!-- Left Panel: Controls & Search -->
    <aside class="w-full md:w-1/3 lg:w-1/4 p-6 bg-white shadow-lg overflow-y-auto">
        <div class="flex items-center space-x-3 mb-6">
            <svg class="w-10 h-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c.24 0 .467-.02.686-.058m-1.372 0a9.004 9.004 0 00-6.654-6.654M12 3c.24 0 .467-.02.686-.058m6.654 6.654a9.004 9.004 0 00-6.654-6.654m0 0a9.004 9.004 0 00-6.654 6.654M3 12c0 .24.02.467.058.686m1.372 0a9.004 9.004 0 006.654 6.654m0 0a9.004 9.004 0 006.654-6.654m0 0c.038-.219.058-.446.058-.686s-.02-.467-.058-.686M12 12c-1.33 0-2.582.403-3.646 1.103m6.292 0c-1.064-.7-2.316-1.103-3.646-1.103" />
            </svg>
            <h1 class="text-2xl font-bold text-gray-800">Provider Finder</h1>
        </div>

        <!-- REMOVED: Database loading is now done on the server -->
        <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
            <p id="db-status" class="text-sm font-medium text-blue-700">
                Ready to search! The provider database is live on the server.
            </p>
        </div>


        <!-- Step 1: Search Parameters -->
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                Search Criteria
            </label>
            <div class="space-y-4">
                <div>
                    <label for="address-input" class="block text-xs font-medium text-gray-600 mb-1">Your Location (Address or ZIP)</label>
                    <div class="relative flex items-center">
                        <input type="text" id="address-input" placeholder="e.g., 123 Main St or 90210" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="get-location-btn" title="Use my current location" class="absolute right-2 p-1 text-gray-500 hover:text-blue-600 transition-colors duration-200">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="radius-select" class="block text-xs font-medium text-gray-600 mb-1">Search Radius</label>
                    <select id="radius-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="5">5 miles</option>
                        <option value="10">10 miles</option>
                        <option value="25" selected>25 miles</option>
                        <option value="50">50 miles</option>
                        <option value="100">100 miles</option>
                    </select>
                </div>
                <div>
                    <label for="taxonomy-select" class="block text-xs font-medium text-gray-600 mb-1">Provider Type</label>
                    <select id="taxonomy-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Provider Types</option>
                        <option value="2084P0800X">Psychology, Clinical</option>
                        <option value="101Y00000X">Counselor</option>
                        <option value="101YA0400X">Counselor, Addiction</option>
                        <option value="101YM0800X">Counselor, Mental Health</option>
                        <option value="103T00000X">Social Worker</option>
                        <option value="103TA0700X">Social Worker, Clinical</option>
                        <option value="207Q00000X">Psychiatry</option>
                        <option value="207QA0000X">Psychiatry, Addiction</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Step 2: Run Search -->
        <div class="mb-6">
            <!-- Enabled by default now -->
            <button id="find-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Find Providers
            </button>
        </div>

        <!-- Status Message Area -->
        <div id="status-message" class="text-sm text-center p-3 rounded-lg hidden"></div>
    </aside>

    <!-- Right Panel: Results -->
    <main class="w-full md:w-2/3 lg:w-3/4 h-full flex flex-col p-6">
        <div class="bg-white shadow-lg rounded-xl h-full flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">Results</h2>
                <p id="results-count" class="text-sm text-gray-600 mt-1">Search to see results.</p>
            </div>

            <div id="results-container" class="flex-grow p-4 overflow-y-auto space-y-4">
                <!-- Initial placeholder -->
                <div id="results-placeholder" class="text-center text-gray-500 pt-16">
                    <svg class="w-12 h-12 mx-auto text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                    </svg>
                    <p class="mt-2">Provider results will appear here.</p>
                </div>
            </div>

            <div id="load-more-container" class="p-4 border-t border-gray-200 text-center" style="display: none;">
                <button id="load-more-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg shadow-sm transition-all duration-200 ease-in-out hover:bg-gray-300">
                    Load More
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        // --- Globals ---
        // NEW: URL for the back-end server.
        // Assumes the Python script is running on http://127.0.0.1:5000
        const API_URL = "http://127.0.0.1:5000/api/search";

        // 'allFoundProviders' now only stores the *currently loaded* providers
        let allFoundProviders = [];
        let currentOffset = 0;
        let totalFound = 0; // Total available results on the server
        let userCurrentCoords = null;
        let isSearching = false; // Prevent multiple simultaneous searches

        // --- DOM Elements ---
        const findBtn = document.getElementById('find-btn');
        const addressInput = document.getElementById('address-input');
        const radiusSelect = document.getElementById('radius-select');
        const taxonomySelect = document.getElementById('taxonomy-select');
        const statusMessage = document.getElementById('status-message');
        const resultsContainer = document.getElementById('results-container');
        const resultsPlaceholder = document.getElementById('results-placeholder');
        const resultsCount = document.getElementById('results-count');
        const loadMoreContainer = document.getElementById('load-more-container');
        const loadMoreBtn = document.getElementById('load-more-btn');
        const getLocationBtn = document.getElementById('get-location-btn');

        // REMOVED: initDb() function is no longer needed.

        // --- Geocoding Functions ---

        function handleGetLocation() {
            if (isSearching || !navigator.geolocation) {
                showStatus("Geolocation is not supported or a search is in progress.", "error");
                return;
            }

            showStatus("Getting your location...", "info");
            getLocationBtn.disabled = true;
            findBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    userCurrentCoords = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    showStatus("Location found. Getting address...", "info");

                    try {
                        const address = await reverseGeocode(userCurrentCoords.lat, userCurrentCoords.lon);
                        addressInput.value = address;
                        showStatus("Location found. Starting search...", "success");
                        findProviders(true); // Pass true to indicate new search
                    } catch (err) {
                        showStatus("Found coordinates, but couldn't get address. Starting search...", "info");
                        addressInput.value = `Lat: ${userCurrentCoords.lat.toFixed(4)}, Lon: ${userCurrentCoords.lon.toFixed(4)}`;
                        findProviders(true); // Pass true to indicate new search
                    }
                },
                (err) => {
                    console.warn(`Geolocation error: ${err.message}`);
                    let errorMsg = "Could not get your location.";
                    if (err.code === 1) errorMsg = "Please allow location access to use this feature.";
                    showStatus(errorMsg, "error");
                    getLocationBtn.disabled = false;
                    findBtn.disabled = false;
                }
            );
        }
        getLocationBtn.addEventListener('click', handleGetLocation);

        async function reverseGeocode(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
            try {
                const response = await fetch(url, { headers: { 'User-Agent': 'ProviderFinderWebApp/1.1' } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data && data.display_name) {
                    if (data.address) {
                        const { road, house_number, city, town, village, state, postcode } = data.address;
                        return `${house_number || ''} ${road || ''}, ${city || town || village || ''}, ${state || ''} ${postcode || ''}`.replace(" ,", ",").replace("  ", " ").trim();
                    }
                    return data.display_name;
                }
                throw new Error("Could not determine address.");
            } catch (err) {
                console.error("Reverse geocoding error:", err);
                throw new Error("Could not determine address from coordinates.");
            }
        }

        async function geocodeAddress(address) {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
            try {
                const response = await fetch(url, { headers: { 'User-Agent': 'ProviderFinderWebApp/1.1' } });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data && data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                }
                throw new Error("Address not found.");
            } catch (err) {
                console.error("Geocoding error:", err);
                throw new Error("Could not find coordinates for the address.");
            }
        }

        // REMOVED: Haversine distance. This is now done on the server.

        // --- Show/Hide Status Message ---
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `text-sm text-center p-3 rounded-lg ${
                type === 'error' ? 'bg-red-100 text-red-700' :
                type === 'success' ? 'bg-green-100 text-green-700' :
                'bg-blue-100 text-blue-700'
            } block`;
        }
        function hideStatus() {
            statusMessage.className = 'hidden';
        }

        // REMOVED: rowToObject helper. The server will send clean JSON.

        // --- Main Search Function (REFACTORED) ---
        async function findProviders(isNewSearch = true) {
            if (isSearching) return;
            isSearching = true;

            // Reset results if it's a new search
            if (isNewSearch) {
                currentOffset = 0;
                allFoundProviders = [];
            }

            setLoadingState(true);

            let coordsToUse;
            if (isNewSearch && userCurrentCoords) {
                showStatus("Using your current location...", "info");
                coordsToUse = userCurrentCoords;
                userCurrentCoords = null; // Clear it after use
            } else if (isNewSearch) {
                const locationStr = addressInput.value.trim();
                if (!locationStr) {
                    showStatus("Please enter an address or ZIP code.", "error");
                    setLoadingState(false);
                    return;
                }
                showStatus("Getting your location...", "info");
                try {
                    coordsToUse = await geocodeAddress(locationStr);
                } catch (err) {
                    showStatus(err.message, "error");
                    setLoadingState(false);
                    return;
                }
            } else {
                // This is a "Load More" call, we reuse the last coordinates.
                // We need to get them from the address input again if not stored.
                // A better way is to store them globally.
                // Let's re-geocode. (A more robust app would store this.)
                const locationStr = addressInput.value.trim();
                showStatus("Loading more results...", "info");
                try {
                     coordsToUse = await geocodeAddress(locationStr);
                } catch (err) {
                    showStatus(err.message, "error");
                    setLoadingState(false);
                    return;
                }
            }

            if (!coordsToUse) {
                 showStatus("Could not determine location for search.", "error");
                 setLoadingState(false);
                 return;
            }

            showStatus("Searching for providers...", "info");

            const radius = parseFloat(radiusSelect.value);
            const selectedTaxonomy = taxonomySelect.value;

            // --- NEW: API Call ---
            try {
                const url = new URL(API_URL);
                url.searchParams.append('lat', coordsToUse.lat);
                url.searchParams.append('lon', coordsToUse.lon);
                url.searchParams.append('radius', radius);
                url.searchParams.append('taxonomy', selectedTaxonomy);
                url.searchParams.append('offset', currentOffset);

                const response = await fetch(url);
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || `Server error: ${response.status}`);
                }

                const data = await response.json();

                // Append new results
                allFoundProviders.push(...data.results);
                totalFound = data.total; // Update total count

                displayResults();
                hideStatus();

            } catch (err) {
                console.error("API Search error:", err);
                showStatus(`Search failed: ${err.message}`, "error");
                // If it was a "Load More" that failed, reset offset
                if (!isNewSearch) currentOffset -= RESULTS_PER_PAGE;
            } finally {
                setLoadingState(false);
            }
        }
        findBtn.addEventListener('click', () => findProviders(true));

        // --- Helper to manage loading state ---
        function setLoadingState(isLoading) {
            isSearching = isLoading;
            findBtn.disabled = isLoading;
            getLocationBtn.disabled = isLoading;
            loadMoreBtn.disabled = isLoading;
            findBtn.textContent = isLoading ? "Searching..." : "Find Providers";
            if (isLoading) loadMoreBtn.textContent = "Loading...";
            else loadMoreBtn.textContent = "Load More";
        }

        // --- Function to display results (REFACTORED) ---
        function displayResults() {
            if (resultsPlaceholder) {
                resultsPlaceholder.style.display = 'none';
            }

            // For "Load More", we append instead of clearing
            // Let's change that: clear and re-render all is simpler.
            resultsContainer.innerHTML = ''; // Clear all results

            if (allFoundProviders.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center text-gray-500 pt-16">
                        <svg class="w-12 h-12 mx-auto text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.964 1.769a.75.75 0 01-1.214-.882c.28-.314.63-.58 1.003-.79.744-.36 1.45-.997 1.963-1.768a.75.75 0 01.34-1.353c.644-.042 1.255-.11 1.85-.169a.75.75 0 00.728-.734c.002-.516-.076-1.03-.22-1.521a.75.75 0 00-.734-.728c-.516.002-1.03.076-1.521.22a.75.75 0 00-.728.734c.042.644.11 1.255.169 1.85a.75.75 0 01-1.353.34c-.508.771-1.218 1.408-1.963 1.768-.373.18-.722.42-1.003.79a.75.75 0 01-1.214-.882c.514-.77 1.22-1.407 1.964-1.769.24-.116.467-.263.67-.442 1.172-1.025 1.172-2.687 0-3.712-1.171-1.025-3.071-1.025-4.242 0-1.172 1.025-1.172 2.687 0 3.712zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                        </svg>
                        <p class="mt-2 font-semibold">No Providers Found</p>
                        <p class="text-sm">Try expanding your search radius or changing the provider type.</p>
                    </div>
                `;
            }

            // Render all providers currently in the 'allFoundProviders' array
            allFoundProviders.forEach(provider => {
                const card = document.createElement('div');
                card.className = "p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm transition-all duration-200 hover:shadow-md";

                let mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(provider.Name + ", " + provider.Address + ", " + provider.City + ", " + provider.State)}`;

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-blue-700">${provider.Name}</h3>
                            <p class="text-sm text-gray-600">${provider.Address}</p>
                            <p class="text-sm text-gray-600">${provider.City}, ${provider.State} ${provider.PostalCode}</p>
                            <p class="text-xs text-gray-500 mt-1">NPI: ${provider.NPI}</p>
                        </div>
                        <div class="text-right flex-shrink-0 ml-4">
                            <p classR="text-lg font-bold text-gray-800">${provider.distance.toFixed(1)} mi</p>
                            <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-500 hover:underline">
                                View Map
                            </a>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(card);
            });

            // Update count
            resultsCount.textContent = `Showing ${allFoundProviders.length} of ${totalFound} results.`;

            // Show or hide the "Load More" button
            if (totalFound > allFoundProviders.length) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        // --- Load More Event Listener (REFACTORED) ---
        loadMoreBtn.addEventListener('click', () => {
            currentOffset += RESULTS_PER_PAGE; // Increment the offset
            findProviders(false); // Call findProviders, indicating it's NOT a new search
        });

    </script>
</body>
</html>

